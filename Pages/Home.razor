@page "/"
@using Models
@using Services
@using Utilities
@layout MainLayout

@inject FlightService FlightService
@inject SeatService SeatService
@inject PassengerSeatService PassengerSeatService
@inject TicketService TicketService
@inject AirportService AirportService
@inject IJSRuntime JS

<PageTitle>Ticket System</PageTitle>

<div class="container mt-3">

    <!-- ======================= -->
    <!-- TOP NAV TABS -->
    <!-- ======================= -->
    <ul class="nav nav-tabs mb-3" role="tablist">

        <!-- HOME TAB -->
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "home" ? "active" : "")"
                    @onclick='() => SwitchTab("home")'
                    type="button">
                Home
            </button>
        </li>

        <!-- RESERVATION TAB -->
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "flight" ? "active" : "")"
                    @onclick='() => SwitchTab("flight")'
                    type="button">
                Reservation
            </button>
        </li>

    </ul>

    <!-- ======================= -->
    <!-- HOME TAB CONTENT -->
    <!-- ======================= -->
    @if (activeTab == "home")
    {
        <!-- SEARCH SECTION -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Fly with us!</div>
            <div class="card-body">

                <div class="row g-3">

                    <!-- FROM AIRPORT -->
                    <div class="col-md-6">
                        <label class="form-label">From</label>
                        <select class="form-control" @bind="from">
                            <option value="">Select origin...</option>
                            @foreach (var a in AirportService.GetAllAirports())
                            {
                                <option value="@a.Code">@a.Code - @a.City (@a.Country)</option>
                            }
                        </select>
                    </div>

                    <!-- TO AIRPORT -->
                    <div class="col-md-6">
                        <label class="form-label">To</label>
                        <select class="form-control" @bind="to">
                            <option value="">Select destination...</option>
                            @foreach (var a in AirportService.GetAllAirports())
                            {
                                <option value="@a.Code">@a.Code - @a.City (@a.Country)</option>
                            }
                        </select>
                    </div>

                    <!-- DATE -->
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input id="travelDatePicker" class="form-control" />
                    </div>

                    <!-- PASSENGERS -->
                    <div class="col-md-6">
                        <label class="form-label">Passengers</label>
                        <input type="number" class="form-control" min="1" @bind="passengers" />
                    </div>

                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-primary"
                            @onclick="SearchFlights"
                            disabled="@IsSearchDisabled">
                        Search Flights
                    </button>
                </div>
            </div>
        </div>

        <!-- SEARCH RESULTS -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Search Results</div>
            <div class="card-body">

                @if (flights.Count == 0)
                {
                    <p class="text-muted">No flights found.</p>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var flight in flights)
                        {
                            <div class="list-group-item mb-3">

                                <div class="d-flex justify-content-between">
                                    <h5>@flight.From → @flight.To</h5>
                                    <small>@flight.Departure.ToString("yyyy-MM-dd HH:mm")</small>
                                </div>

                                <p class="mb-1 text-muted">
                                    @flight.Airline · @flight.FlightNumber · @flight.DurationMinutes min · Seats: @flight.SeatsAvailable · @flight.Price:C
                                </p>

                                <button class="btn btn-success mt-2"
                                        @onclick="() => PickSeat(flight)">
                                    Pick Seat
                                </button>
                            </div>
                        }
                    </div>
                }

            </div>
        </div>

        <!-- SEAT PICKER -->
        @if (pickingSeat && currentFlight != null)
        {
            <div class="card mb-4">
                <div class="card-header fw-bold">
                    Pick a seat — @currentFlight.Airline @currentFlight.FlightNumber
                </div>

                <div class="card-body">

                    <strong>Selected seat:</strong> @(selectedSeat?.SeatNumber ?? "None")

                    @if (seatOptions.Count == 0)
                    {
                        <p class="text-muted">No seats available.</p>
                    }
                    else
                    {
                        @foreach (var row in seatRows)
                        {
                            <div class="d-flex mb-2">
                                <strong class="me-3">@row.Key</strong>
                                @foreach (var seat in row)
                                {
                                    bool isSelected = selectedSeat?.SeatNumber == seat.SeatNumber;

                                    <button class="btn btn-sm me-2 @(isSelected ? "btn-primary" : "btn-outline-secondary")"
                                            @onclick="() => OnSeatClicked(seat)">
                                        @seat.SeatNumber
                                    </button>
                                }
                            </div>
                        }

                        <button class="btn btn-success mt-3"
                                @onclick="FinishSeatPicking"
                                disabled="@(PassengerSeatService.Count < passengers)">
                            Done
                        </button>

                        <button class="btn btn-secondary mt-3 ms-2"
                                @onclick="CancelPick">
                            Cancel
                        </button>
                    }
                </div>
            </div>
        }

        <!-- PASSENGER MODAL -->
        @if (showPassengerModal)
        {
            <div class="modal fade show d-block" style="z-index:1060;" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">
                                Passenger Info — Seat @selectedSeat?.SeatNumber
                            </h5>
                            <button class="btn-close" @onclick="ClosePassengerModal"></button>
                        </div>

                        <div class="modal-body">
                            <label>Name</label>
                            <input class="form-control mb-2" @bind="passengerName" />

                            <label>Age</label>
                            <input type="number" class="form-control mb-2" @bind="passengerAge" />

                            <label>Gender</label>
                            <input class="form-control mb-2" @bind="passengerGender" />

                            <small>@PassengerSeatService.Count / @passengers passengers added</small>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="ClosePassengerModal">Cancel</button>
                            <button class="btn btn-primary"
                                    @onclick="ConfirmPassenger"
                                    disabled="@IsPassengerInvalid">
                                Confirm
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="modal-backdrop fade show" style="z-index:1050;"></div>
        }

    }

    <!-- ======================= -->
    <!-- RESERVATION TAB CONTENT -->
    <!-- ======================= -->
    @if (activeTab == "flight")
    {
        <h3>Reservation</h3>

        <input class="form-control mb-2"
               @bind="searchId"
               placeholder="Passenger ID or Seat Number" />

        <button class="btn btn-primary" @onclick="OnEnter">Enter</button>
        <button class="btn btn-danger ms-2" @onclick="OnCancel" disabled="@(!canCancel)">Cancel</button>

        @if (message != null)
        {
            <div class="mt-3 @(isError ? "text-danger" : "text-success")">
                @message
            </div>
        }

        @if (selected != null)
        {
            <div class="card mt-3">
                <div class="card-body">
                    <h5>Reservation Info</h5>

                    @if (!editMode)
                    {
                        <ul>
                            <li><b>Name:</b> @selected.Name</li>
                            <li><b>Seat:</b> @selected.SeatNumber</li>
                            <li><b>Flight:</b> @selected.FlightId</li>
                            @if (flightDetails != null)
                            {
                                <li><b>Airline:</b> @flightDetails.Airline</li>
                                <li><b>Flight #:</b> @flightDetails.FlightNumber</li>
                                <li><b>Departure:</b> @flightDetails.Departure.ToString("g")</li>
                                <li><b>Arrival:</b> @flightDetails.Arrival.ToString("g")</li>
                                <li><b>Price:</b> @flightDetails.Price:C</li>
                            }
                        </ul>

                        <button class="btn btn-secondary" @onclick="BeginEdit">Edit</button>
                    }
                    else
                    {
                        <label>Name</label>
                        <input class="form-control mb-2" @bind="editName" />

                        <label>Seat</label>
                        <input class="form-control mb-2" @bind="editSeatNumber" />

                        <button class="btn btn-success" @onclick="SaveEdit">Save</button>
                        <button class="btn btn-secondary ms-2" @onclick="CancelEdit">Cancel</button>
                    }

                </div>
            </div>
        }
    }

</div>

@code {

    // ======================================================
    // TAB SWITCHING
    // ======================================================

    private string activeTab = "home";

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // ======================================================
    // HOME TAB LOGIC
    // ======================================================

    private string from = "";
    private string to = "";
    private int passengers = 1;

    private ArrayList<Flight> flights = new();
    private DateTime travelDate = DateTime.Today;

    private Flight? currentFlight;
    private bool pickingSeat = false;

    private ArrayList<Seat> seatOptions = new();
    private ILookup<int, Seat>? seatRows;
    private Seat? selectedSeat;

    private bool showPassengerModal = false;

    private string passengerName = "";
    private int passengerAge = 0;
    private string passengerGender = "";

    private bool IsSearchDisabled =>
        string.IsNullOrWhiteSpace(from) ||
        string.IsNullOrWhiteSpace(to) ||
        passengers < 1;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("datePicker.init", "travelDatePicker",
                Array.Empty<string>(),
                DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public void SetTravelDate(string isoDate)
    {
        if (DateTime.TryParse(isoDate, out var dt))
            travelDate = dt;
    }

    private void SearchFlights()
    {
        flights.Clear();

        foreach (var flight in FlightService.SearchFlights(from, to, travelDate, passengers))
            flights.AddLast(flight);
    }

    private void PickSeat(Flight flight)
    {
        currentFlight = flight;
        seatOptions.Clear();

        foreach (var seat in SeatService.GetSeatsByFlightId(flight.Id))
            seatOptions.AddLast(seat);

        seatRows = seatOptions
            .Select(s => new { Seat = s, Row = ParseRowNumber(s.SeatNumber) })
            .Where(x => x.Row.HasValue)
            .OrderBy(x => x.Row)
            .ToLookup(x => x.Row!.Value, x => x.Seat);

        pickingSeat = true;
    }

    private int? ParseRowNumber(string seatNumber)
    {
        var digits = new string(seatNumber.TakeWhile(char.IsDigit).ToArray());
        return int.TryParse(digits, out int r) ? r : null;
    }

    private void CancelPick()
    {
        pickingSeat = false;
        selectedSeat = null;
        currentFlight = null;
    }

    private void OnSeatClicked(Seat seat)
    {
        selectedSeat = seat;
        passengerName = passengerGender = "";
        passengerAge = 0;
        showPassengerModal = true;
    }

    private void ClosePassengerModal()
    {
        showPassengerModal = false;
    }

    private bool IsPassengerInvalid =>
        selectedSeat == null ||
        string.IsNullOrWhiteSpace(passengerName) ||
        string.IsNullOrWhiteSpace(passengerGender);

    private void ConfirmPassenger()
    {
        if (currentFlight == null || selectedSeat == null) return;

        var ps = new PassengerSeat
        {
            Name = passengerName,
            Age = passengerAge,
            Gender = passengerGender,
            FlightId = currentFlight.Id,
            SeatNumber = selectedSeat.SeatNumber
        };

        PassengerSeatService.AddLast(ps);

        var ticket = new Ticket
        {
            Id = ps.Id,
            FlightId = currentFlight.Id,
            SeatId = selectedSeat.SeatNumber,
            From = currentFlight.From,
            To = currentFlight.To,
            HolderName = ps.Name,
            IssueTime = DateTime.Now,
            TravelTime = currentFlight.Departure,
            PassengerCount = 1
        };

        TicketService.AddTicket(ticket);

        currentFlight.SeatsAvailable--;
        SeatService.UpdateSeatAvailability(selectedSeat.FlightId, selectedSeat.SeatNumber, false);

        showPassengerModal = false;

        if (PassengerSeatService.Count >= passengers)
            pickingSeat = false;

        selectedSeat = null;
    }

    private void FinishSeatPicking()
    {
        pickingSeat = false;
        selectedSeat = null;
    }

    // ======================================================
    // RESERVATION TAB LOGIC
    // ======================================================

    private string? searchId;
    private PassengerSeat? selected;
    private Flight? flightDetails;
    private bool canCancel;
    private string? message;
    private bool isError;

    private void OnEnter()
    {
        message = null;
        isError = false;
        selected = null;
        flightDetails = null;

        if (string.IsNullOrWhiteSpace(searchId))
        {
            isError = true;
            message = "Please enter an ID.";
            return;
        }

        selected = PassengerSeatService.FirstOrDefault(
            x => x.Id == searchId || x.SeatNumber == searchId);

        if (selected == null)
        {
            isError = true;
            message = "Reservation not found.";
            return;
        }

        flightDetails = FlightService.GetFlightById(selected.FlightId);

        message = "Reservation loaded.";
        canCancel = true;
    }

    private void OnCancel()
    {
        if (selected == null)
        {
            isError = true;
            message = "No reservation selected.";
            return;
        }

        PassengerSeatService.RemoveWhere(ps => ps.Id == selected.Id);

        message = "Reservation cancelled.";
        selected = null;
        canCancel = false;
    }

    private bool editMode = false;
    private string? editName;
    private string? editSeatNumber;

    private void BeginEdit()
    {
        editMode = true;
        editName = selected?.Name;
        editSeatNumber = selected?.SeatNumber;
    }

    private void CancelEdit()
    {
        editMode = false;
    }

    private void SaveEdit()
    {
        if (selected == null)
        {
            isError = true;
            message = "Cannot update.";
            return;
        }

        if (string.IsNullOrWhiteSpace(editName) ||
            string.IsNullOrWhiteSpace(editSeatNumber))
        {
            isError = true;
            message = "Fields cannot be empty.";
            return;
        }

        selected.Name = editName;
        selected.SeatNumber = editSeatNumber;

        PassengerSeatService.Update(selected);

        editMode = false;
        message = "Reservation updated.";
        isError = false;
    }

}
