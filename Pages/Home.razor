@page "/"
@using Models
@using Services
@using Utilities
@using System.Linq
@layout MainLayout
@inject Services.FlightService FlightService
@inject Services.SeatService SeatService
@inject Services.PassengerSeatService PassengerSeatService

<PageTitle>Ticket System</PageTitle>

<div class="container mt-3">
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <a class="nav-link active" href="#">Home</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/flight" Match="NavLinkMatch.Prefix">Flight</a>
        </li>
    </ul>

    <div class="card mb-4">
        <div class="card-header fw-bold">Fly with us!</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">From</label>
                    <input class="form-control" @bind="from" @bind:event="oninput" list="fromSuggestions"
                        placeholder="Origin" />
                    <datalist id="fromSuggestions">
                        @foreach (string s in suggestions)
                        {
                            <option value="@s"></option>
                        }
                    </datalist>
                </div>

                <div class="col-md-6">
                    <label class="form-label">To</label>
                    <input class="form-control" @bind="to" @bind:event="oninput" list="toSuggestions"
                        placeholder="Destination" />
                    <datalist id="toSuggestions">
                        @foreach (string s in suggestions)
                        {
                            <option value="@s"></option>
                        }
                    </datalist>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Date</label>
                    <input id="travelDatePicker" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label class="form-label">Passengers</label>
                    <input type="number" min="1" class="form-control" @bind="passengers" />
                </div>
            </div>

            <div class="mt-3 text-end">
                <button class="btn btn-primary" @onclick="SearchFlights" disabled="@IsSearchDisabled">
                    Search Flights
                </button>
            </div>
        </div>
    </div>

    <!-- Search results -->
    <div class="card mb-4">
        <div class="card-header fw-bold">Search Results</div>
        <div class="card-body">
            @if (flights == null || flights.Count == 0)
            {
                <p class="text-muted">No flights found.</p>
            }
            else
            {
                <div class="list-group">
                    @foreach (Flight flight in flights)
                    {
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@flight.From &rarr; @flight.To</h5>
                                <small>@flight.Departure.ToString("yyyy-MM-dd HH:mm")</small>
                            </div>

                            <p class="mb-1 text-muted">
                                @($"{flight.Airline} · {flight.FlightNumber} · {flight.DurationMinutes} min ·                        Seats:{flight.SeatsAvailable} · {flight.Price:C}")
                            </p>

                            <pre class="mt-2 mb-0">
                                                                @System.Text.Json.JsonSerializer.Serialize(flight, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })
                                                                                            </pre>
                        </div>

                        <button class="btn btn-sm btn-success mt-2" @onclick="() => PickSeat(flight)">
                            Pick Seat
                        </button>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Seat picker -->
    @if (pickingSeat && currentFlight != null)
    {
        <div class="card mb-4 border-primary">
            <div class="card-header fw-bold">Pick a seat — @currentFlight.Airline @currentFlight.FlightNumber
                (@currentFlight.From → @currentFlight.To)</div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Selected:</strong> @(selectedSeat?.SeatNumber ?? "none")
                </div>

                @if (seatOptions == null || seatOptions.Count == 0)
                {
                    <p class="text-muted">No seat data available.</p>
                }
                else
                {
                    <div class="d-flex flex-column">
                        @foreach (IGrouping<int, Seat> row in seatRows)
                        {
                            <div class="d-flex mb-2">
                                <div class="me-3 align-self-center" style="width:3rem">@row.Key</div>
                                <div class="d-flex flex-wrap">
                                    @foreach (Seat seat in row)
                                    {
                                        var isSelected = selectedSeat != null && selectedSeat.SeatNumber == seat.SeatNumber;
                                        <button class="btn btn-sm me-2 mb-2 @(isSelected ? "btn-primary" : "btn-outline-secondary")"
                                            @onclick="() => OnSeatClicked(seat)">
                                            @seat.SeatNumber
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-success me-2" @onclick="FinishSeatPicking"
                            disabled="@(PassengerSeatService.Count == 0)">
                            Done
                        </button>
                        <button class="btn btn-secondary" @onclick="CancelPick">Cancel</button>
                    </div>
                }
            </div>
        </div>
    }

    @if (showPassengerModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" style="z-index: 1060;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Passenger's Info — Seat @selectedSeat?.SeatNumber</h5>
                        <button type="button" class="btn-close" @onclick="ClosePassengerModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input class="form-control" @bind="passengerName" autofocus />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Age</label>
                            <input type="number" min="0" class="form-control" @bind="passengerAge" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gender</label>
                            <input class="form-control" @bind="passengerGender" />
                        </div>
                        <div>
                            <small class="text-muted">(@PassengerSeatService.Count / @passengers) added</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="ClosePassengerModal">Cancel</button>
                        <button class="btn btn-primary" @onclick="ConfirmPassenger"
                            disabled="@IsPassengerInvalid">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
    }

    @if (showTicketDetails)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true" style="z-index: 1060;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Ticket Created</h5>
                        <button type="button" class="btn-close" @onclick="CloseTicketDetails"></button>
                    </div>
                    <div class="modal-body">
                        <p>Your ticket ID is <code>@lastPassengerSeat?.Id</code>. Use this to search the ticket's details.
                        </p>
                        <small class="text-muted">Store this ID safely.</small>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" @onclick="CloseTicketDetails">OK</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
    }

</div>

@code {
    private string _from = "";
    private string _to = "";
    private int passengers = 1;
    private bool pickingSeat = false;
    private Flight? currentFlight = null;
    private ArrayList<Seat> seatOptions = new();
    private Seat? selectedSeat = null;
    private bool showTicketDetails = false;
    private ILookup<int, Seat> seatRows = null!; // grouped by numeric row
    private string to
    {
        get => _to;
        set
        {
            _to = value;
            UpdateToSuggestions();
            _datePickerNeedsInit = true;
        }
    }

    private string from
    {
        get => _from;
        set
        {
            _from = value;
            UpdateFromSuggestions();
            _datePickerNeedsInit = true;
        }
    }

    private ArrayList<string> suggestions = new();
    private DateTime travelDate = DateTime.Today;
    private bool _datePickerNeedsInit = true;
    private ArrayList<Flight> flights = new();

    [Inject] private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_datePickerNeedsInit) return;

        string[] availableDates = FlightService
        .Where(f =>
        (string.IsNullOrWhiteSpace(_from) || f.From.Equals(_from, StringComparison.OrdinalIgnoreCase)) &&
        (string.IsNullOrWhiteSpace(_to) || f.To.Equals(_to, StringComparison.OrdinalIgnoreCase))
        )
        .Select(f => f.Departure.Date)
        .Distinct()
        .Select(d => d.ToString("yyyy-MM-dd"))
        .ToArray();

        await JS.InvokeVoidAsync("datePicker.init",
        "travelDatePicker",
        availableDates,
        DotNetObjectReference.Create(this));

        _datePickerNeedsInit = false;
    }

    [JSInvokable]
    public void SetTravelDate(string isoDate)
    {
        if (DateTime.TryParse(isoDate, out DateTime dt))
        {
            travelDate = dt;
            StateHasChanged();
        }
    }

    private void UpdateToSuggestions()
    {
        suggestions.Clear();
        if (string.IsNullOrWhiteSpace(_to)) return;

        foreach (string s in FlightService.SuggestTo(_from, _to).Take(10))
        {
            suggestions.AddLast(s);
        }
    }

    private void UpdateFromSuggestions()
    {
        suggestions.Clear();
        if (string.IsNullOrWhiteSpace(_from)) return;

        foreach (string s in FlightService.SuggestFrom(_from).Take(10))
        {
            suggestions.AddLast(s);
        }
    }

    private bool IsSearchDisabled =>
    string.IsNullOrWhiteSpace(_from) ||
    string.IsNullOrWhiteSpace(_to) ||
    passengers < 1;

    private void SearchFlights()
    {
        foreach (Flight flight in FlightService.SearchFlights(_from, _to, travelDate, passengers))
        {
            flights.AddLast(flight);
        }
    }

    private void PickSeat(Flight flight)
    {
        currentFlight = flight;

        IEnumerable<Seat> _seatOptions = SeatService.GetSeatsByFlightId(flight.Id);
        foreach (Seat seat in _seatOptions)
        {
            seatOptions.AddLast(seat);
        }
        selectedSeat = null;
        BuildSeatRows();
        pickingSeat = true;
    }

    private void BuildSeatRows()
    {
        // group seats by numeric row (e.g. "12A" -> 12) for display order
        seatRows = seatOptions
        .Select(s => new { Seat = s, Row = ParseRowNumber(s.SeatNumber) })
        .Where(x => x.Row.HasValue)
        .OrderBy(x => x.Row!.Value)
        .ThenBy(x => x.Seat.SeatNumber)
        .ToLookup(x => x.Row!.Value, x => x.Seat);
    }

    private int? ParseRowNumber(string seatNumber)
    {
        if (string.IsNullOrWhiteSpace(seatNumber)) return null;
        var digits = new string(seatNumber.TakeWhile(char.IsDigit).ToArray());
        if (int.TryParse(digits, out int r)) return r;
        return null;
    }

    private void CancelPick()
    {
        pickingSeat = false;
        selectedSeat = null;
        currentFlight = null;
    }

    private bool showPassengerModal = false;

    private string passengerName = "";
    private int passengerAge = 0;
    private string passengerGender = "";
    private PassengerSeat? lastPassengerSeat =>
    PassengerSeatService.Count > 0 ? PassengerSeatService[^1] : null;

    private bool IsPassengerInvalid =>
    selectedSeat == null ||
    string.IsNullOrWhiteSpace(passengerName) ||
    string.IsNullOrWhiteSpace(passengerGender);

    private void OnSeatClicked(Seat seat)
    {
        selectedSeat = seat;
        ResetPassengerForm();
        showPassengerModal = true;
    }

    private void ResetPassengerForm()
    {
        passengerName = "";
        passengerAge = 0;
        passengerGender = "";
    }

    private void ClosePassengerModal()
    {
        showPassengerModal = false;
        selectedSeat = null;
    }

    private void ConfirmPassenger()
    {

        if (currentFlight == null || selectedSeat == null) return;

        PassengerSeat passengerSeat = new PassengerSeat
        {
            Name = passengerName.Trim(),
            Age = passengerAge,
            Gender = passengerGender.Trim(),
            SeatNumber = selectedSeat.SeatNumber,
            FlightId = selectedSeat.FlightId
        };

        PassengerSeatService.AddLast(
        passengerSeat
        );

        // update availability
        if (currentFlight.SeatsAvailable > 0)
            currentFlight.SeatsAvailable--;

        seatOptions.RemoveAll(s => s.SeatNumber == selectedSeat.SeatNumber && s.FlightId == selectedSeat.FlightId);
        SeatService.UpdateSeatAvailability(selectedSeat.FlightId, selectedSeat.SeatNumber, false);
        BuildSeatRows();

        showPassengerModal = false;
        selectedSeat = null;

        // auto-finish if reached passenger count
        if (PassengerSeatService.Count >= passengers)
        {
            pickingSeat = false;
        }

        showTicketDetails = true;



        StateHasChanged();
    }

    private void FinishSeatPicking()
    {
        pickingSeat = false;
        selectedSeat = null;
    }

    private void CloseTicketDetails()
    {
        showTicketDetails = false;
    }
}