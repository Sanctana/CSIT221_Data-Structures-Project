@page "/"
@using Models
@using Utilities
@using Services
@layout MainLayout

@inject FlightService FlightService
@inject SeatService SeatService
@inject PassengerSeatService PassengerSeatService
@inject TicketService TicketService
@inject AirportService AirportService
@inject IJSRuntime JS

<PageTitle>Ticket System</PageTitle>

<div class="container mt-3">

    <!-- Tabs -->
<ul class="nav nav-tabs mb-3" role="tablist">

    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "home" ? "active" : "")"
                @onclick="() => SwitchTab("home")"
                type="button">
            Home
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "flight" ? "active" : "")"
                @onclick="() => SwitchTab("flight")"
                type="button">
            Reservation
        </button>
    </li>

</ul>


    <!-- HOME TAB -->
    @if (activeTab == "home")
    {
        <!-- Search Card -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Fly with us!</div>
            <div class="card-body">

                <div class="row g-3">
                    <!-- FROM -->
                    <div class="col-md-6">
                        <label class="form-label">From</label>
                        <input class="form-control"
                               @bind="from"
                               @bind:event="oninput"
                               list="airportFromList"
                               placeholder="Type city, airport, or code" />


                        <datalist id="airportFromList">
                            @foreach (var a in airportSuggestionsFrom)
                            {
                                <option value="@a.Code">@a.City (@a.Code) — @a.Name</option>
                            }
                        </datalist>
                    </div>

                    <!-- TO -->
                    <div class="col-md-6">
                        <label class="form-label">To</label>
                        <input class="form-control"
                               @bind="to"
                               @bind:event="oninput"
                               list="airportToList"
                               placeholder="Type city, airport, or code" />

                        <datalist id="airportToList">
                            @foreach (var a in airportSuggestionsTo)
                            {
                                <option value="@a.Code">@a.City (@a.Code) — @a.Name</option>
                            }
                        </datalist>
                    </div>

                    <!-- DATE -->
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input id="travelDatePicker" class="form-control" />
                    </div>

                    <!-- PASSENGERS -->
                    <div class="col-md-6">
                        <label class="form-label">Passengers</label>
                        <input type="number" min="1" class="form-control" @bind="passengers" />
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-primary" @onclick="SearchFlights" disabled="@IsSearchDisabled">
                        Search Flights
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Search Results</div>
            <div class="card-body">

                @if (flights.Count == 0)
                {
                    <p class="text-muted">No flights found.</p>
                }
                else
                {
                    <div class="list-group">
                        @foreach (var flight in flights)
                        {
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <h5>@flight.From → @flight.To</h5>
                                    <small>@flight.Departure.ToString("yyyy-MM-dd HH:mm")</small>
                                </div>

                                <p class="mb-1 text-muted">
                                    @($"{flight.Airline} • {flight.FlightNumber} • {flight.DurationMinutes} min • Seats:{flight.SeatsAvailable} • {flight.Price:C}")
                                </p>
                            </div>

                            <button class="btn btn-sm btn-success mt-2" @onclick="() => PickSeat(flight)">
                                Pick Seat
                            </button>
                        }
                    </div>
                }
            </div>
        </div>

        <!-- Seat Picker -->
        @if (pickingSeat && currentFlight != null)
        {
            <div class="card mb-4 border-primary">
                <div class="card-header fw-bold">
                    Pick a seat — @currentFlight.Airline @currentFlight.FlightNumber (@currentFlight.From → @currentFlight.To)
                </div>

                <div class="card-body">

                    <div class="mb-2">
                        <strong>Selected:</strong> @(selectedSeat?.SeatNumber ?? "none")
                    </div>

                    @if (seatOptions.Count == 0)
                    {
                        <p class="text-muted">No seat data available.</p>
                    }
                    else
                    {
                        <div class="d-flex flex-column">
                            @foreach (var row in seatRows)
                            {
                                <div class="d-flex mb-2">
                                    <div class="me-3 align-self-center" style="width:3rem">@row.Key</div>
                                    <div class="d-flex flex-wrap">
                                        @foreach (var seat in row)
                                        {
                                            var isSelected = selectedSeat != null && selectedSeat.SeatNumber == seat.SeatNumber;

                                            <button class="btn btn-sm me-2 mb-2 @(isSelected ? "btn-primary" : "btn-outline-secondary")"
                                                    @onclick="() => OnSeatClicked(seat)">
                                                @seat.SeatNumber
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-success me-2"
                                    @onclick="FinishSeatPicking"
                                    disabled="@(PassengerSeatService.Count == 0)">
                                Done
                            </button>
                            <button class="btn btn-secondary" @onclick="CancelPick">Cancel</button>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Passenger Modal -->
        @if (showPassengerModal)
        {
            <div class="modal fade show d-block" style="z-index:1060;">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Passenger's Info — Seat @selectedSeat?.SeatNumber</h5>
                            <button type="button" class="btn-close" @onclick="ClosePassengerModal"></button>
                        </div>

                        <div class="modal-body">
                            <label class="form-label">Name</label>
                            <input class="form-control" @bind="passengerName" />

                            <label class="form-label mt-2">Age</label>
                            <input type="number" min="0" class="form-control" @bind="passengerAge" />

                            <label class="form-label mt-2">Gender</label>
                            <input class="form-control" @bind="passengerGender" />

                            <small class="text-muted d-block mt-2">
                                @PassengerSeatService.Count / @passengers added
                            </small>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="ClosePassengerModal">Cancel</button>
                            <button class="btn btn-primary" @onclick="ConfirmPassenger" disabled="@IsPassengerInvalid">
                                Confirm
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="modal-backdrop fade show" style="z-index:1050;"></div>
        }

        <!-- Ticket ID Modal -->
        @if (showTicketDetails)
        {
            <div class="modal fade show d-block" style="z-index:1060;">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Ticket Created</h5>
                            <button type="button" class="btn-close" @onclick="CloseTicketDetails"></button>
                        </div>

                        <div class="modal-body">
                            <p>Your ticket ID is <code>@lastPassengerSeat?.Id</code>.</p>
                            <small class="text-muted">Store this ID safely.</small>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-primary" @onclick="CloseTicketDetails">OK</button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="modal-backdrop fade show" style="z-index:1050;"></div>
        }
    }

    <!-- FLIGHT TAB -->
    @if (activeTab == "flight")
    {
        <h3>Reservation</h3>

        <div style="max-width:600px;">
            <label>Enter ID/confirmation:</label>
            <input class="form-control" @bind="searchId" placeholder="Passenger Id or Seat Number" />

            <button class="btn btn-primary mt-2" @onclick="OnEnter">Enter</button>
            <button class="btn btn-danger mt-2 ms-2" @onclick="OnCancel" disabled="@(!canCancel)">Cancel</button>

            @if (message is not null)
            {
                <div class="mt-3 @(isError ? "text-danger" : "text-success")">
                    @message
                </div>
            }

            @if (selected is not null)
            {
                <div class="mt-3">
                    <h4>Info</h4>

                    @if (!editMode)
                    {
                        <ul>
                            <li><b>Name:</b> @selected.Name</li>
                            <li><b>Route:</b> Flight @selected.FlightId</li>
                            <li><b>Seat:</b> @selected.SeatNumber</li>

                            @if (flightDetails != null)
                            {
                                <li><b>Airline:</b> @flightDetails.Airline</li>
                                <li><b>Flight #:</b> @flightDetails.FlightNumber</li>
                                <li><b>Departure:</b> @flightDetails.Departure.ToString("g")</li>
                                <li><b>Arrival:</b> @flightDetails.Arrival.ToString("g")</li>
                                <li><b>Price:</b> @flightDetails.Price.ToString("C")</li>
                                <li><b>Seats available:</b> @flightDetails.SeatsAvailable</li>
                            }
                        </ul>

                        <button class="btn btn-secondary" @onclick="BeginEdit">Edit</button>
                    }
                    else
                    {
                        <label>Name</label>
                        <input class="form-control" @bind="editName" />

                        <label class="mt-2">Seat</label>
                        <input class="form-control" @bind="editSeatNumber" />

                        <button class="btn btn-success mt-2" @onclick="SaveEdit">Save</button>
                        <button class="btn btn-secondary mt-2 ms-2" @onclick="CancelEdit">Cancel</button>
                    }
                </div>
            }
        </div>
    }

</div>

@code {
    // -----------------------
    // TAB MANAGEMENT
    // -----------------------

    private string activeTab = "home";

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // -----------------------
    // HOME TAB STATE
    // -----------------------

    private string from = "";
    private string to = "";
    private int passengers = 1;
    private Flight? currentFlight;
    private bool pickingSeat = false;

    private ArrayList<Flight> flights = new();
    private ArrayList<Seat> seatOptions = new();
    private Seat? selectedSeat;
    private ILookup<int, Seat>? seatRows;

    // airport suggestions
    private List<Airport> airportSuggestionsFrom = new();
    private List<Airport> airportSuggestionsTo = new();

    // date picker
    private DateTime travelDate = DateTime.Today;
    private bool _datePickerNeedsInit = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !_datePickerNeedsInit)
            return;

        // find available dates
        string[] availableDates = FlightService
            .Where(f => (string.IsNullOrWhiteSpace(from) || f.From == from) &&
                        (string.IsNullOrWhiteSpace(to) || f.To == to))
            .Select(f => f.Departure.Date)
            .Distinct()
            .Select(d => d.ToString("yyyy-MM-dd"))
            .ToArray();

        await JS.InvokeVoidAsync("datePicker.init",
            "travelDatePicker",
            availableDates,
            DotNetObjectReference.Create(this));

        _datePickerNeedsInit = false;
    }

    [JSInvokable]
    public void SetTravelDate(string isoDate)
    {
        if (DateTime.TryParse(isoDate, out var dt))
        {
            travelDate = dt;
            StateHasChanged();
        }
    }

    // airport search
    private void UpdateFromSuggestions()
    {
        airportSuggestionsFrom = AirportService.Search(from).Take(10).ToList();
        _datePickerNeedsInit = true;
    }

    private void UpdateToSuggestions()
    {
        airportSuggestionsTo = AirportService.Search(to).Take(10).ToList();
        _datePickerNeedsInit = true;
    }

    // search validation
    private bool IsSearchDisabled =>
        string.IsNullOrWhiteSpace(from) ||
        string.IsNullOrWhiteSpace(to) ||
        passengers < 1;

    private void SearchFlights()
    {
        flights.Clear();
        foreach (var f in FlightService.SearchFlights(from, to, travelDate, passengers))
        {
            flights.AddLast(f);
        }
    }

    // -----------------------
    // SEAT PICKING
    // -----------------------

    private void PickSeat(Flight flight)
    {
        currentFlight = flight;
        pickingSeat = true;
        selectedSeat = null;

        seatOptions.Clear();
        foreach (var s in SeatService.GetSeatsByFlightId(flight.Id))
            seatOptions.AddLast(s);

        BuildSeatRows();
    }

    private void BuildSeatRows()
    {
        seatRows = seatOptions
            .Select(s => new { Seat = s, Row = ParseRowNumber(s.SeatNumber) })
            .Where(x => x.Row.HasValue)
            .OrderBy(x => x.Row.Value)
            .ThenBy(x => x.Seat.SeatNumber)
            .ToLookup(x => x.Row!.Value, x => x.Seat);
    }

    private int? ParseRowNumber(string seatNumber)
    {
        var digits = new string(seatNumber.TakeWhile(char.IsDigit).ToArray());
        return int.TryParse(digits, out int row) ? row : null;
    }

    private void CancelPick()
    {
        pickingSeat = false;
        currentFlight = null;
        selectedSeat = null;
    }

    // -----------------------
    // PASSENGER MODAL
    // -----------------------

    private bool showPassengerModal = false;
    private string passengerName = "";
    private int passengerAge;
    private string passengerGender = "";

    private PassengerSeat? lastPassengerSeat =>
        PassengerSeatService.Count > 0 ? PassengerSeatService[^1] : null;

    private bool IsPassengerInvalid =>
        selectedSeat == null ||
        string.IsNullOrWhiteSpace(passengerName) ||
        string.IsNullOrWhiteSpace(passengerGender);

    private void OnSeatClicked(Seat seat)
    {
        selectedSeat = seat;
        ResetPassengerForm();
        showPassengerModal = true;
    }

    private void ResetPassengerForm()
    {
        passengerName = "";
        passengerAge = 0;
        passengerGender = "";
    }

    private void ClosePassengerModal()
    {
        selectedSeat = null;
        showPassengerModal = false;
    }

    private void ConfirmPassenger()
    {
        if (currentFlight == null || selectedSeat == null)
            return;

        // create passenger
        var passengerSeat = new PassengerSeat
        {
            Name = passengerName.Trim(),
            Age = passengerAge,
            Gender = passengerGender.Trim(),
            SeatNumber = selectedSeat.SeatNumber,
            FlightId = selectedSeat.FlightId
        };

        PassengerSeatService.AddLast(passengerSeat);

        // create ticket
        var ticket = new Ticket
        {
            Id = passengerSeat.Id,
            FlightId = currentFlight.Id,
            SeatId = selectedSeat.SeatNumber,
            From = currentFlight.From,
            To = currentFlight.To,
            HolderName = passengerSeat.Name,
            IssueTime = DateTime.Now,
            TravelTime = currentFlight.Departure,
            PassengerCount = 1
        };

        TicketService.AddTicket(ticket);

        // update seat availability
        SeatService.UpdateSeatAvailability(selectedSeat.FlightId, selectedSeat.SeatNumber, false);

        if (currentFlight.SeatsAvailable > 0)
            currentFlight.SeatsAvailable--;

        seatOptions.RemoveAll(s => s.SeatNumber == selectedSeat.SeatNumber &&
                                   s.FlightId == selectedSeat.FlightId);

        BuildSeatRows();

        showPassengerModal = false;
        selectedSeat = null;

        if (PassengerSeatService.Count >= passengers)
        {
            pickingSeat = false;
        }

        showTicketDetails = true;
        StateHasChanged();
    }

    private bool showTicketDetails = false;

    private void CloseTicketDetails()
    {
        showTicketDetails = false;
    }

    private void FinishSeatPicking()
    {
        pickingSeat = false;
        selectedSeat = null;
    }

    // -----------------------
    // RESERVATION LOOKUP (Flight Tab)
    // -----------------------

    private string? searchId;
    private PassengerSeat? selected;
    private Flight? flightDetails;
    private bool canCancel;
    private string? message;
    private bool isError;
    private bool editMode;
    private string? editName;
    private string? editSeatNumber;

    private void OnEnter()
    {
        selected = PassengerSeatService.FirstOrDefault(ps =>
            ps.Id.Equals(searchId, StringComparison.OrdinalIgnoreCase) ||
            ps.SeatNumber.Equals(searchId, StringComparison.OrdinalIgnoreCase));

        if (selected == null)
        {
            isError = true;
            message = "Reservation not found.";
            canCancel = false;
            return;
        }

        // load flight
        try
        {
            flightDetails = FlightService.GetFlightById(selected.FlightId);
        }
        catch
        {
            flightDetails = null;
        }

        isError = false;
        message = "Reservation found.";
        canCancel = true;
    }

    private void OnCancel()
    {
        if (selected == null)
        {
            message = "No reservation selected.";
            isError = true;
            return;
        }

        var tuple = PassengerSeatService
            .Select((ps, i) => (ps, i))
            .FirstOrDefault(t => t.ps.Id == selected.Id);

        if (tuple == default)
        {
            message = "Failed to cancel.";
            isError = true;
            return;
        }

        PassengerSeatService.RemoveAt(tuple.i);
        selected = null;
        flightDetails = null;
        canCancel = false;
        message = "Cancelled successfully.";
        isError = false;
    }

    private void BeginEdit()
    {
        if (selected == null) return;

        editMode = true;
        editName = selected.Name;
        editSeatNumber = selected.SeatNumber;
    }

    private void CancelEdit()
    {
        editMode = false;
        editName = editSeatNumber = null;
    }

    private void SaveEdit()
    {
        if (selected == null)
        {
            message = "No reservation.";
            isError = true;
            return;
        }

        if (string.IsNullOrWhiteSpace(editName) || string.IsNullOrWhiteSpace(editSeatNumber))
        {
            message = "Fields cannot be empty.";
            isError = true;
            return;
        }

        var tuple = PassengerSeatService
            .Select((ps, i) => (ps, i))
            .FirstOrDefault(t => t.ps.Id == selected.Id);

        if (tuple == default)
        {
            message = "Failed to update.";
            isError = true;
            return;
        }

        var updated = new PassengerSeat
        {
            Id = selected.Id,
            Name = editName!,
            SeatNumber = editSeatNumber!,
            FlightId = selected.FlightId,
            Age = selected.Age,
            Gender = selected.Gender
        };

        PassengerSeatService[tuple.i] = updated;

        selected = updated;
        editMode = false;

        message = "Updated successfully.";
        isError = false;
    }
}



