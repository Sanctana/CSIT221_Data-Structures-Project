@page "/"
@using Models
@using Services
@layout MainLayout

@inject FlightService FlightService
@inject SeatService SeatService
@inject PassengerSeatService PassengerSeatService
@inject TicketService TicketService
@inject IJSRuntime JS

<PageTitle>Ticket System</PageTitle>

<div class="container mt-3">
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
            <button class="nav-link @(activeTab == "home" ? "active" : "")"
                    @onclick="() => SwitchTab("home")">
                Home
            </button>
        </li>

        <li class="nav-item">
            <button class="nav-link @(activeTab == "flight" ? "active" : "")"
                    @onclick="() => SwitchTab("flight")">
                Flight
            </button>
        </li>
    </ul>

    @* ---------------- HOME TAB ---------------- *@
    @if (activeTab == "home")
    {
        <!-- SEARCH PANEL -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Fly with us!</div>
            <div class="card-body">

                <div class="row g-3">

                    <!-- FROM -->
                    <div class="col-md-6">
                        <label class="form-label">From</label>
                        <select class="form-control" @bind="from">
                            <option value="">Select departure airport</option>
                            @foreach (var ap in Airports)
                            {
                                <option value="@ap.Key">@ap.Key — @ap.Value</option>
                            }
                        </select>
                    </div>

                    <!-- TO -->
                    <div class="col-md-6">
                        <label class="form-label">To</label>
                        <select class="form-control" @bind="to">
                            <option value="">Select destination airport</option>
                            @foreach (var ap in Airports)
                            {
                                if (ap.Key != from)
                                {
                                    <option value="@ap.Key">@ap.Key — @ap.Value</option>
                                }
                            }
                        </select>
                    </div>

                    <!-- DATE -->
                    <div class="col-md-6">
                        <label class="form-label">Date</label>
                        <input id="travelDatePicker" class="form-control" />
                    </div>

                    <!-- PASSENGERS -->
                    <div class="col-md-6">
                        <label class="form-label">Passengers</label>
                        <input type="number" min="1" class="form-control" @bind="passengers" />
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-primary" @onclick="SearchFlights" disabled="@IsSearchDisabled">
                        Search Flights
                    </button>
                </div>

            </div>
        </div>

        <!-- SEARCH RESULTS -->
        <div class="card mb-4">
            <div class="card-header fw-bold">Search Results</div>
            <div class="card-body">

                @if (flights.Count == 0)
                {
                    <p class="text-muted">No flights found.</p>
                }
                else
                {
                    @foreach (var flight in flights)
                    {
                        <div class="boarding-pass mb-3" @onclick="@(() => PickSeat(flight))">

                            <div class="bp-top">
                                <div class="bp-route">
                                    <span class="bp-airport">@flight.From</span>
                                    <span class="bp-arrow">→</span>
                                    <span class="bp-airport">@flight.To</span>
                                </div>

                                <div class="bp-airline">
                                    @flight.Airline
                                    <span class="bp-flight-number">@flight.FlightNumber</span>
                                </div>
                            </div>

                            <div class="bp-middle">
                                <div>
                                    <div class="bp-label">Departure</div>
                                    <div class="bp-value">@flight.Departure.ToString("MMM dd, yyyy HH:mm")</div>
                                </div>

                                <div>
                                    <div class="bp-label">Duration</div>
                                    <div class="bp-value">@flight.DurationMinutes min</div>
                                </div>

                                <div>
                                    <div class="bp-label">Seats</div>
                                    <div class="bp-value">@flight.SeatsAvailable</div>
                                </div>

                                <div>
                                    <div class="bp-label">Price</div>
                                    <div class="bp-value">@flight.Price.ToString("C")</div>
                                </div>
                            </div>

                        </div>
                    }
                }

            </div>
        </div>

        <!-- SEAT PICKER -->
        @if (pickingSeat && currentFlight != null)
        {
            <div class="card mb-4 border-primary">
                <div class="card-header fw-bold">
                    Pick a seat — @currentFlight.Airline @currentFlight.FlightNumber
                </div>

                <div class="card-body">

                    <div class="mb-2">
                        <strong>Selected seat:</strong> @(selectedSeat?.SeatNumber ?? "none")
                    </div>

                    @if (seatRows == null || !seatRows.Any())
                    {
                        <p class="text-muted">No seat data available.</p>
                    }
                    else
                    {
                        <div class="d-flex flex-column">
                            @foreach (var row in seatRows)
                            {
                                <div class="d-flex mb-2">
                                    <div class="me-3 align-self-center" style="width:3rem">@row.Key</div>
                                    <div class="d-flex flex-wrap">
                                        @foreach (var seat in row)
                                        {
                                            bool isSelected = selectedSeat?.SeatNumber == seat.SeatNumber;

                                            <button class="btn btn-sm me-2 mb-2 
                                                    @(isSelected ? "btn-primary" : "btn-outline-secondary")"
                                                    @onclick="(() => OnSeatClicked(seat))">
                                                @seat.SeatNumber
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-success me-2"
                                    @onclick="FinishSeatPicking"
                                    disabled="@(PassengerSeatService.Count == 0)">
                                Done
                            </button>

                            <button class="btn btn-secondary" @onclick="CancelSeatPick">
                                Cancel
                            </button>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- PASSENGER MODAL -->
        @if (showPassengerModal)
        {
            @* Modal UI *@
            <div class="modal fade show d-block" tabindex="-1" style="z-index: 1060;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                Passenger Info — Seat @selectedSeat?.SeatNumber
                            </h5>
                            <button class="btn-close" @onclick="ClosePassengerModal"></button>
                        </div>

                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input class="form-control" @bind="passengerName" autofocus />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Age</label>
                                <input class="form-control" type="number" min="1" @bind="passengerAge" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Gender</label>
                                <input class="form-control" @bind="passengerGender" />
                            </div>

                            <small class="text-muted">
                                (@PassengerSeatService.Count / @passengers) added
                            </small>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="ClosePassengerModal">Cancel</button>
                            <button class="btn btn-primary" @onclick="ConfirmPassenger" disabled="@IsPassengerInvalid">Confirm</button>
                        </div>

                    </div>
                </div>
            </div>

            @* Modal backdrop *@
            <div class="modal-backdrop fade show" style="z-index: 1050;"></div>
        }

        <!-- TICKET CREATED MODAL -->
        @if (showTicketDetails)
        {
            <div class="modal fade show d-block" tabindex="-1" style="z-index: 1060;">
                <div class="modal-dialog">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Ticket Created</h5>
                            <button class="btn-close" @onclick="(() => showTicketDetails = false)"></button>
                        </div>

                        <div class="modal-body">
                            <p>Your ticket ID is:</p>
                            <code>@lastPassengerSeat?.Id</code>
                            <br />
                            <small class="text-muted">Keep this ID safe.</small>
                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-primary" @onclick="(() => showTicketDetails = false)">
                                OK
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <div class="modal-backdrop fade show"></div>
        }

    }

    @* ---------------- FLIGHT TAB (Reservation Lookup) ---------------- *@
    @if (activeTab == "flight")
    {
        <h3>Reservation</h3>

        <div class="reservation-form-container" style="max-width:600px;">

            <label>Enter ID/confirmation:</label>
            <input class="form-control" @bind="searchId" placeholder="Passenger ID or Seat Number" />

            <button class="btn btn-primary mt-2" @onclick="OnEnter">Enter</button>
            <button class="btn btn-danger mt-2 ms-2" @onclick="OnCancel" disabled="@(!canCancel)">Cancel</button>

            @if (message != null)
            {
                <div class="@(isError ? "message-error" : "message-success") mt-3">
                    @message
                </div>
            }

            @if (selected != null)
            {
                <div class="reservation-info mt-3">
                    <h4>Info</h4>

                    @if (!editMode)
                    {
                        <ul>
                            <li><b>Name:</b> @selected.Name</li>
                            <li><b>Route:</b> Flight @selected.FlightId</li>
                            <li><b>Seat:</b> @selected.SeatNumber</li>

                            @if (flightDetails != null)
                            {
                                <li><b>Airline:</b> @flightDetails.Airline</li>
                                <li><b>Flight #:</b> @flightDetails.FlightNumber</li>
                                <li><b>Departure:</b> @flightDetails.Departure</li>
                                <li><b>Arrival:</b> @flightDetails.Arrival</li>
                                <li><b>Price:</b> @flightDetails.Price.ToString("C")</li>
                            }
                        </ul>

                        <button class="btn btn-secondary" @onclick="BeginEdit">Edit</button>
                    }
                    else
                    {
                        <div>
                            <label>Name</label>
                            <input class="form-control" @bind="editName" />

                            <label class="mt-2">Seat</label>
                            <input class="form-control" @bind="editSeatNumber" />

                            <button class="btn btn-success mt-2" @onclick="SaveEdit">Save</button>
                            <button class="btn btn-secondary mt-2 ms-2" @onclick="CancelEdit">Cancel</button>
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {

    /* ---------------- CORE STATE ---------------- */

    private string activeTab = "home";
    private string from = "";
    private string to = "";
    private int passengers = 1;
    private DateTime travelDate = DateTime.Today;

    /* ---------------- SEARCH RESULTS ---------------- */

    private List<Flight> flights = new();
    private Flight? currentFlight;
    private bool pickingSeat = false;

    /* ---------------- SEATS ---------------- */

    private List<Seat> seatOptions = new();
    private Seat? selectedSeat;
    private ILookup<int, Seat>? seatRows;

    /* ---------------- PASSENGER MODAL ---------------- */

    private bool showPassengerModal = false;
    private string passengerName = "";
    private int passengerAge = 0;
    private string passengerGender = "";

    private PassengerSeat? lastPassengerSeat =>
        PassengerSeatService.Count > 0 ? PassengerSeatService[PassengerSeatService.Count - 1] : null;

    private bool IsPassengerInvalid =>
        selectedSeat == null ||
        string.IsNullOrWhiteSpace(passengerName) ||
        string.IsNullOrWhiteSpace(passengerGender);

    /* ---------------- RESERVATION LOOKUP ---------------- */

    private string? searchId;
    private PassengerSeat? selected;
    private Flight? flightDetails;
    private bool canCancel = false;
    private string? message;
    private bool isError = false;

    private bool editMode = false;
    private string? editName;
    private string? editSeatNumber;

    /* ---------------- AIRPORT LIST ---------------- */

    private readonly Dictionary<string, string> Airports = new()
    {
        { "LAX", "Los Angeles (California)" },
        { "JFK", "New York – John F. Kennedy (New York)" },
        { "SFO", "San Francisco (California)" },
        { "SEA", "Seattle (Washington)" },
        { "ORD", "Chicago O’Hare (Illinois)" },
        { "DFW", "Dallas–Fort Worth (Texas)" },
        { "DEN", "Denver (Colorado)" },
        { "ATL", "Atlanta (Georgia)" },
        { "MNL", "Manila (Philippines)" },
        { "CEB", "Cebu (Philippines)" },
        { "DVO", "Davao (Philippines)" }
    };

    /* ---------------- TAB SWITCHING ---------------- */

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    /* ---------------- SEARCH LOGIC ---------------- */

    private bool IsSearchDisabled =>
        string.IsNullOrWhiteSpace(from) ||
        string.IsNullOrWhiteSpace(to) ||
        passengers < 1;

    private void SearchFlights()
    {
        flights.Clear();

        var results = FlightService.SearchFlights(from, to, travelDate, passengers);

        foreach (var f in results)
            flights.Add(f);
    }

    /* ---------------- DATE PICKER ---------------- */

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!activeTab.Equals("home"))
            return;

        // get available dates for selected route
        var dates = FlightService
            .Where(f => f.From == from && f.To == to)
            .Select(f => f.Departure.Date.ToString("yyyy-MM-dd"))
            .Distinct()
            .ToArray();

        await JS.InvokeVoidAsync("datePicker.init",
            "travelDatePicker",
            dates,
            DotNetObjectReference.Create(this));
    }

    [JSInvokable]
    public void SetTravelDate(string iso)
    {
        if (DateTime.TryParse(iso, out var dt))
            travelDate = dt;
    }

    /* ---------------- SEAT PICKER ---------------- */

    private void PickSeat(Flight flight)
    {
        currentFlight = flight;
        pickingSeat = true;

        seatOptions = SeatService.GetSeatsByFlightId(flight.Id).ToList();

        seatRows = seatOptions
            .Select(s => new { Seat = s, Row = GetRow(s.SeatNumber) })
            .Where(x => x.Row > 0)
            .OrderBy(x => x.Row)
            .ThenBy(x => x.Seat.SeatNumber)
            .ToLookup(x => x.Row, x => x.Seat);

        selectedSeat = null;
    }

    private int GetRow(string seat)
    {
        var num = new string(seat.Where(char.IsDigit).ToArray());
        return int.TryParse(num, out int n) ? n : -1;
    }

    private void CancelSeatPick()
    {
        pickingSeat = false;
        selectedSeat = null;
        currentFlight = null;
    }

    private void OnSeatClicked(Seat seat)
    {
        selectedSeat = seat;

        passengerName = "";
        passengerGender = "";
        passengerAge = 0;

        showPassengerModal = true;
    }

    private void ClosePassengerModal()
    {
        showPassengerModal = false;
        selectedSeat = null;
    }

    /* ---------------- CONFIRM PASSENGER ---------------- */

    private void ConfirmPassenger()
    {
        if (selectedSeat == null || currentFlight == null)
            return;

        var ps = new PassengerSeat
        {
            Name = passengerName,
            Age = passengerAge,
            Gender = passengerGender,
            SeatNumber = selectedSeat.SeatNumber,
            FlightId = selectedSeat.FlightId
        };

        PassengerSeatService.AddPassengerSeat(ps);

        var ticket = new Ticket
        {
            Id = ps.Id,
            FlightId = currentFlight.Id,
            SeatId = ps.SeatNumber,
            From = currentFlight.From,
            To = currentFlight.To,
            HolderName = ps.Name,
            IssueTime = DateTime.Now,
            TravelTime = currentFlight.Departure,
            PassengerCount = 1
        };

        TicketService.AddTicket(ticket);

        currentFlight.SeatsAvailable--;
        SeatService.UpdateSeatAvailability(ps.FlightId, ps.SeatNumber, false);

        seatOptions.RemoveAll(s => s.SeatNumber == ps.SeatNumber);
        ClosePassengerModal();

        if (PassengerSeatService.Count >= passengers)
            pickingSeat = false;

        showTicketDetails = true;
    }

    private void FinishSeatPicking()
    {
        pickingSeat = false;
        selectedSeat = null;
    }

    /* ---------------- RESERVATION LOOKUP ---------------- */

    private void OnEnter()
    {
        message = null;
        isError = false;
        selected = null;
        flightDetails = null;

        if (string.IsNullOrWhiteSpace(searchId))
        {
            message = "Please enter an ID or seat number.";
            isError = true;
            return;
        }

        selected = PassengerSeatService
            .FirstOrDefault(ps =>
                ps.Id.Equals(searchId, StringComparison.OrdinalIgnoreCase) ||
                ps.SeatNumber.Equals(searchId, StringComparison.OrdinalIgnoreCase));

        if (selected == null)
        {
            message = "Reservation not found.";
            isError = true;
            return;
        }

        flightDetails = FlightService.GetFlightById(selected.FlightId);

        canCancel = true;
        message = "Reservation loaded.";
    }

    private void OnCancel()
    {
        if (selected == null)
        {
            isError = true;
            message = "No reservation selected.";
            return;
        }

        var index = PassengerSeatService.IndexOf(ps => ps.Id == selected.Id);
        if (index >= 0)
        {
            PassengerSeatService.RemoveAt(index);
            canCancel = false;
            selected = null;
            flightDetails = null;
            message = "Reservation cancelled.";
        }
        else
        {
            isError = true;
            message = "Failed to cancel.";
        }
    }

    private void BeginEdit()
    {
        editMode = true;
        editName = selected?.Name;
        editSeatNumber = selected?.SeatNumber;
    }

    private void CancelEdit()
    {
        editMode = false;
        editName = null;
        editSeatNumber = null;
    }

    private void SaveEdit()
    {
        if (selected == null)
            return;

        if (string.IsNullOrWhiteSpace(editName) || string.IsNullOrWhiteSpace(editSeatNumber))
        {
            message = "Fields cannot be empty.";
            isError = true;
            return;
        }

        var index = PassengerSeatService.IndexOf(ps => ps.Id == selected.Id);
        if (index == -1)
        {
            message = "Failed to locate reservation.";
            isError = true;
            return;
        }

        var updated = new PassengerSeat
        {
            Id = selected.Id,
            FlightId = selected.FlightId,
            Name = editName!,
            SeatNumber = editSeatNumber!,
            Gender = selected.Gender,
            Age = selected.Age
        };

        PassengerSeatService[index] = updated;
        selected = updated;

        editMode = false;
        message = "Reservation updated.";
        isError = false;
    }
}
